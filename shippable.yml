build_environment: ubuntu1404

language: php

php:
  - 5.6

reset_minion: true

env:
  global:
    - secure: gKI98uwhu3EEP00RdyPwQP/z2JGSKHXWJDzHR1W3PQRlR+1UlLHTEqV93ehBMmsJjYiXidz2D/1Gk7VGPBDMGA4GSHlQ72YMG/1xrvyVWmotgdKq6Yqsu8ruVRg4/oqAn7w7DeoV6TzfcBbnOSacRpI7RFmLilcXuCgm9TAOry7mxKHzTfC0yGxTGQ6Bw+Q7/s1/dVtoGVvPM5GArSZEvkFZFTCHLfq6sRXC0e1MhuJX35MzlUZr/va57OJAGqa9Gnpw4B5iqVNNDHzKCG1s47mJji3UyzJVSWkeh6L9ydJ6bf3QkRJb8ZCJ3ov2p6KpA7Sa3m+Fqz7/RsbXRtHL5g==

before_script:
  - echo "APP_ENV=building" >> .env
  - echo "PGSQL_PASSWORD=" >> .env
  - echo "PGSQL_USER=postgres" >> .env
  - mkdir -p shippable/testresults
  - psql -c 'CREATE DATABASE groupeat;' -U postgres
  - echo "xdebug.max_nesting_level = 250" >> ~/.phpenv/versions/$(phpenv version-name)/etc/php.ini
  - composer config -g github-oauth.github.com $GITHUB_TOKEN
  - composer self-update
  - composer install --no-interaction --no-progress
  - php artisan db:install --seed --entries 2
  - ./vendor/bin/codecept build

script:
  - ./vendor/bin/phpcs
  - ./vendor/bin/codecept run --fail-fast --debug --xml ../../shippable/testresults/results.xml

after_success:
  - if [[ $(git log -1 HEAD --pretty=format:%s) != *skip\ deploy* ]]; then echo "Starting deployment"; ./rocketeer.phar deploy; else echo "Deployment cancelled"; fi

notifications:
     email:
         recipients:
             - tib.dex@gmail.com
         on_success: change
         on_failure: always
